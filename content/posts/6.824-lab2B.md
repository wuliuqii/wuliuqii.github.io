---
title: "6.824 Lab2B"
date: 2022-01-23T12:35:24+08:00
categories:
tags:
draft: true
---

# 6.824 Lab 2A

课程主页: https://pdos.csail.mit.edu/6.824/schedule.html

Lab2: https://pdos.csail.mit.edu/6.824/labs/lab-raft.html

论文: https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf

## 要求

raft 算法通过领导人机制，将一致性问题分解成了三个相对独立的子问题：

1.   领导选举
2.   日志复制
3.   安全性

Lab 2B 主要的任务就是在 2A 的基础上增加日志。

## 实现

本阶段涉除了选举和心跳外，还涉及日志复制以及和客户端的交互。这里的交互指的是：对外提供添加日志的接口以及达成一致后通知客户端。

### start

客户端通过 start 接口向 raft 集群添加日志，返回三个参数：新增日志的索引、周期以及是否是领导者。

```go
func (rf *Raft) Start(command interface{}) (int, int, bool) {
	rf.mu.Lock()
	defer rf.mu.Unlock()
	index, _ := rf.lastIndexTerm()
	term := rf.term
	isLeader := rf.state == Leader
	if isLeader {
		rf.logEntries = append(rf.logEntries, entry{
			Term:    term,
			Command: command,
		})
		rf.matchIndex[rf.me] = index + 1

	}

	return index + 1, term, isLeader
}
```



![image-20220123123532127](https://cdn.jsdelivr.net/gh/wuliuqii/pic@master/img/6.824-2B-result.png)



![image-20220123231244404](https://cdn.jsdelivr.net/gh/wuliuqii/pic@master/img/6.824-2C-result.png)

